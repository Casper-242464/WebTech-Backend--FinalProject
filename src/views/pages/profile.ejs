<%- include("../partials/header", { title }) %>
<section class="glass-panel p-4 mb-4">
  <div id="profile-view">
    <div class="d-flex align-items-start gap-4 mb-3">
      <% if (user.avatarUrl) { %>
        <img src="<%= user.avatarUrl %>" alt="<%= user.username %>" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
      <% } else { %>
        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 100px; height: 100px;">
          <span style="font-size: 2.5rem; color: white;"><%= user.username.charAt(0).toUpperCase() %></span>
        </div>
      <% } %>
      <div class="flex-grow-1">
        <h1 class="section-title">Welcome, <%= user.username %></h1>
        <p class="muted">Email: <%= user.email %></p>
        <p class="muted">Role: <%= user.role %></p>
        <p><%= user.bio || "No bio yet. Click edit to add one!" %></p>
      </div>
      <button class="btn btn-outline-light" onclick="toggleEditMode()">Edit Profile</button>
    </div>
  </div>

  <div id="profile-edit" style="display: none;">
    <form id="profile-form">
      <div class="mb-3">
        <label class="form-label">Profile Picture URL</label>
        <input type="text" class="form-control" id="avatarUrl" name="avatarUrl" value="<%= user.avatarUrl || '' %>" placeholder="https://example.com/avatar.jpg">
        <small class="text-muted">Enter a URL to an image for your profile picture</small>
      </div>
      <div class="mb-3">
        <label class="form-label">Bio</label>
        <textarea class="form-control" id="bio" name="bio" rows="3" placeholder="Tell us about yourself..."><%= user.bio || '' %></textarea>
      </div>
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <button type="button" class="btn btn-outline-secondary" onclick="toggleEditMode()">Cancel</button>
      </div>
    </form>
  </div>
</section>

<section>
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="section-title">Your Recipes</h2>
    <a class="btn btn-outline-light" href="/recipes/new">Create new</a>
  </div>
  <div class="row g-4">
    <% if (recipes.length === 0) { %>
      <div class="col-12">
        <div class="glass-panel p-4">No recipes yet.</div>
      </div>
    <% } %>
    <% recipes.forEach((recipe) => { %>
      <div class="col-md-6">
        <article class="recipe-card h-100">
          <% if (recipe.imageUrl) { %>
            <img src="<%= recipe.imageUrl %>" alt="<%= recipe.title %>" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px 8px 0 0;">
          <% } %>
          <div class="recipe-card-body">
            <h3><%= recipe.title %></h3>
            <p class="muted"><%= recipe.description || "No description provided." %></p>
            <div class="recipe-meta">
              <span><%= recipe.cookTimeMinutes %> min</span>
              <span><%= recipe.calories %> cal</span>
            </div>
          </div>
          <div class="recipe-card-footer">
            <a class="btn btn-sm btn-outline-light" href="/recipes/<%= recipe._id %>/view">View</a>
            <button class="btn btn-sm btn-danger" onclick="deleteRecipe('<%= recipe._id %>')">Delete</button>
          </div>
        </article>
      </div>
    <% }); %>
  </div>
</section>

<script>
function toggleEditMode() {
  const viewMode = document.getElementById('profile-view');
  const editMode = document.getElementById('profile-edit');
  
  if (viewMode.style.display === 'none') {
    viewMode.style.display = 'block';
    editMode.style.display = 'none';
  } else {
    viewMode.style.display = 'none';
    editMode.style.display = 'block';
  }
}

document.getElementById('profile-form')?.addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = {
    bio: document.getElementById('bio').value,
    avatarUrl: document.getElementById('avatarUrl').value
  };
  
  fetch('/users/profile', {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    credentials: 'same-origin',
    body: JSON.stringify(formData)
  })
  .then(response => {
    if (response.ok) {
      alert('Profile updated successfully');
      location.reload();
    } else {
      return response.json().then(data => {
        throw new Error(data.message || 'Failed to update profile');
      });
    }
  })
  .catch(error => {
    alert('Error: ' + error.message);
  });
});

function deleteRecipe(recipeId) {
  if (!confirm('Are you sure you want to delete this recipe? This action cannot be undone.')) {
    return;
  }
  
  fetch(`/recipes/${recipeId}`, {
    method: 'DELETE',
    credentials: 'same-origin'
  })
  .then(response => {
    if (response.ok) {
      alert('Recipe deleted successfully');
      location.reload();
    } else {
      return response.json().then(data => {
        throw new Error(data.message || 'Failed to delete recipe');
      });
    }
  })
  .catch(error => {
    alert('Error: ' + error.message);
  });
}
</script>
<%- include("../partials/footer") %>
